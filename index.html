<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Math Quiz (Simplified + Safari Fix)</title>
<style>
:root { --quiz-font-size: 120px; }
*{box-sizing:border-box}
html,body{height:100%;overflow:hidden;-webkit-text-size-adjust:none;text-size-adjust:none;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:#f6f7fb;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang TC","Noto Sans TC","Noto Sans","Microsoft JhengHei",sans-serif;color:#222}
.app{position:fixed;inset:0;display:flex;justify-content:center}
.container{height:100%;overflow-y:auto;max-width:720px;margin:0 auto;padding:16px}
.card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:20px}
h1{margin:0 0 12px;font-size:clamp(22px,3.2vw,36px)}
input,button{font-size:16px;font-family:inherit}

/* Buttons */
.actions{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
button{border:0;border-radius:12px;background:#1a73e8;color:#fff;cursor:pointer;min-height:44px}
button.secondary{background:#e0e3eb;color:#222}
.actions button{font-size:24px;padding:.8em 1.4em}

.row{display:grid;grid-template-columns:220px 1fr;gap:12px;align-items:center;margin:10px 0}
.row label{font-size:clamp(14px,1.4vw,20px)}
.row input{width:100%;border:1px solid #ddd;border-radius:12px;padding:12px;font-family:inherit}

.card+.card{margin-top:16px}

/* Quiz layout (simplified) */
.timer{font-size:18px;color:#555;text-align:right;margin-bottom:8px}
.question{display:flex;align-items:center;justify-content:center;text-align:center;padding:16px 12px}
.question span{font-weight:800;line-height:1.1;font-size:var(--quiz-font-size);white-space:nowrap;letter-spacing:-0.02em}
.feedback{min-height:1.6em;font-size:16px;text-align:center;margin-top:6px}
.feedback.ok{color:#0a8a3a}
.feedback.no{color:#c62828}

/* Simple bottom answer bar */
.answer-bar{position:fixed;left:0;right:0;bottom:0;display:flex;justify-content:center;align-items:center;padding:12px;background:rgba(255,255,255,.95);backdrop-filter:blur(4px);border-top-left-radius:12px;border-top-right-radius:12px;box-shadow:0 -6px 18px rgba(0,0,0,.06)}
.answer-bar form{display:flex;gap:12px;justify-content:center;align-items:center;width:100%}
.answer-bar input{padding:.3em .5em;text-align:center;width:min(12ch,60%);font-size:18px;-webkit-appearance:none;appearance:none}
.answer-bar button{padding:.8em 1.6em}

.hidden{display:none!important}
.notice{margin-top:8px;color:#666;font-size:13px}

/* Extra guard: on WebKit/iOS, cap huge sizes to prevent odd jumps */
@supports (-webkit-touch-callout: none){
  .question span{ font-size:clamp(32px,8.5vw,96px); }
}
</style>
</head>
<body>
<div class="app" id="appRoot">
  <div class="container" id="appScroll">
    <div id="settings" class="card" aria-labelledby="title">
      <h1 id="title">Math Quiz Settings</h1>
      <div class="row"><label for="tl">Time Limit (sec):</label><input id="tl" type="number" min="1" value="5" /></div>
      <div class="row"><label for="tq">Total Questions:</label><input id="tq" type="number" min="1" value="10" /></div>
      <div class="row"><label for="series">Series (comma or "all"):</label><input id="series" type="text" value="all" /></div>
      <div class="row"><label for="fs">Font Size (base, px):</label><input id="fs" type="number" min="12" value="120" /></div>
      <div class="row"><label for="review">Review Mistakes:</label><div><input id="review" type="checkbox" /><div id="reviewTip" class="notice"></div></div></div>
      <div class="actions">
        <button id="startBtn" type="button">Start Quiz</button>
        <button id="exportBtn" class="secondary" type="button">Export Results (CSV)</button>
      </div>
    </div>

    <div id="quiz" class="card hidden" aria-live="polite">
      <div id="timer" class="timer">Time left: 0s</div>
      <div class="question">
        <span id="qText"></span>
      </div>
      <div id="feedback" class="feedback" aria-live="polite"></div>

      <div class="answer-bar">
        <form id="answerForm" autocomplete="off">
          <input id="ans" type="text" inputmode="numeric" enterkeyhint="send"
                 autocapitalize="off" autocorrect="off" autocomplete="off" aria-label="Your answer" />
          <button id="submitBtn" type="submit">Submit</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Elements
  const elSettings = document.getElementById('settings');
  const elQuiz = document.getElementById('quiz');
  const elStart = document.getElementById('startBtn');
  const elExport = document.getElementById('exportBtn');
  const elTL = document.getElementById('tl');
  const elTQ = document.getElementById('tq');
  const elSeries = document.getElementById('series');
  const elFS = document.getElementById('fs');
  const elReview = document.getElementById('review');
  const elReviewTip = document.getElementById('reviewTip');
  const elQText = document.getElementById('qText');
  const elAns = document.getElementById('ans');
  const elSubmit = document.getElementById('submitBtn');
  const elForm = document.getElementById('answerForm');
  const elTimer = document.getElementById('timer');
  const elFeedback = document.getElementById('feedback');

  // State
  let quizData = [], idx = 0, timerId = null, timeLeft = 0;
  let mistakes = [], allowReview = false, composing = false;
  let score = 0, history = [], lastSubmitTs = -1;

  // Settings (simple localStorage)
  function saveSettings(){
    const s = { tl: elTL.value, tq: elTQ.value, series: elSeries.value, fs: elFS.value, allowReview, mistakes };
    localStorage.setItem('mathQuizSettings', JSON.stringify(s));
  }
  function loadSettings(){
    const s = JSON.parse(localStorage.getItem('mathQuizSettings') || '{}');
    if (s.tl) elTL.value = s.tl;
    if (s.tq) elTQ.value = s.tq;
    if (s.series) elSeries.value = s.series;
    if (s.fs) elFS.value = s.fs;
    if (s.allowReview) { allowReview = true; elReview.checked = true; }
    if (Array.isArray(s.mistakes)) mistakes = s.mistakes;
    document.documentElement.style.setProperty('--quiz-font-size', (parseInt(elFS.value,10)||120) + 'px');
    updateReviewTip();
  }
  function updateReviewTip(){
    const m = mistakes.length || 0;
    elReviewTip.textContent = m ? `可複習 ${m} 題錯題（勾選後將以錯題清單出題）` : '目前沒有錯題可複習';
  }

  // Quiz generation (simplified)
  function parseSeries(){
    const seriesVal = elSeries.value.trim().toLowerCase();
    let tables = [];
    if (seriesVal === 'all') tables = [...Array(9).keys()].map(i => i + 1);
    else tables = seriesVal.split(',').map(v => parseInt(v.trim(),10)).filter(v => v >= 1 && v <= 9);
    return tables.length ? tables : [1];
  }
  function genQuiz(){
    quizData = [];
    const tables = parseSeries();
    const total = Math.max(1, parseInt(elTQ.value,10) || 10);
    for (let i = 0; i < total; i++) {
      const a = tables[Math.floor(Math.random() * tables.length)];
      const b = Math.floor(Math.random() * 9) + 1;
      quizData.push({ a, b, ans: a * b });
    }
  }

  function showQ(){
    if (idx >= quizData.length) return endQuiz();
    const q = quizData[idx];
    elQText.textContent = `${q.a} × ${q.b} = ?`;
    elFeedback.textContent = '';
    elFeedback.className = 'feedback';
    elAns.value = '';
    // focus (Safari safe)
    requestAnimationFrame(()=>{ elAns.focus({preventScroll:true}); });
    const tl = Math.max(1, parseInt(elTL.value,10) || 5);
    timeLeft = tl; elTimer.textContent = `Time left: ${timeLeft}s`;
    clearInterval(timerId);
    const startTs = performance.now();
    timerId = setInterval(()=>{
      timeLeft--; elTimer.textContent = `Time left: ${timeLeft}s`;
      if(timeLeft<=0){ clearInterval(timerId); submit({force:true, usedMs: performance.now()-startTs}); }
    },1000);
  }

  function submit(opts={}){
    if (composing) return; // IME safety
    const now = performance.now();
    if (now - lastSubmitTs < 150) return; // light debounce
    lastSubmitTs = now;

    const q = quizData[idx];
    const yourRaw = elAns.value.trim();
    const your = yourRaw === '' ? '∅' : yourRaw;
    const ok = String(q.ans) === your;
    const usedMs = opts.usedMs || 0;

    history.push({ a:q.a, b:q.b, correct:q.ans, your, ok, usedMs: Math.round(usedMs), ts:new Date().toISOString() });
    if (!ok) mistakes.push(q); else score++;

    elFeedback.textContent = ok ? '✓ Correct' : `✗ Incorrect (Ans: ${q.ans})`;
    elFeedback.className = 'feedback ' + (ok ? 'ok' : 'no');

    clearInterval(timerId);
    idx++;
    setTimeout(()=>showQ(), 280);
  }

  function startQuiz(){
    document.documentElement.style.setProperty('--quiz-font-size', (parseInt(elFS.value,10)||120) + 'px');
    score = 0; history = []; idx = 0;
    if (elReview.checked && allowReview && mistakes.length) quizData = [...mistakes];
    else genQuiz();
    mistakes = [];
    elSettings.classList.add('hidden');
    elQuiz.classList.remove('hidden');
    showQ();
  }

  function endQuiz(){
    clearInterval(timerId);
    allowReview = true;
    saveSettings();
    updateReviewTip();
    alert(`Done! Score: ${score}/${quizData.length}`);
    elSettings.classList.remove('hidden');
    elQuiz.classList.add('hidden');
  }

  // IME-safe: only one set of listeners (no pointer/touch duplication)
  elAns.addEventListener('compositionstart',()=>{ composing = true; });
  elAns.addEventListener('compositionend',()=>{ composing = false; });
  elForm.addEventListener('submit', (e)=>{ e.preventDefault(); submit(); });
  elSubmit.addEventListener('click', (e)=>{ e.preventDefault(); submit(); });

  elStart.addEventListener('click', ()=> startQuiz());

  // CSV export (full results)
  elExport.addEventListener('click', ()=>{
    if(!history.length){ alert('No data to export. Complete a quiz first.'); return; }
    const rows = [[ 'A','B','CorrectAnswer','YourAnswer','IsCorrect','TimeUsed(ms)','Timestamp' ],
      ...history.map(r=>[r.a,r.b,r.correct,r.your,r.ok?1:0,r.usedMs,r.ts])];
    const csv = rows.map(r=>r.join(',')).join('
');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'quiz_results.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Init
  document.addEventListener('DOMContentLoaded', loadSettings);
})();
</script>
</body>
</html>
