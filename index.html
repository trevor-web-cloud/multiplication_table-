<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Math Quiz (No PWA)</title>
<style>
:root { --quiz-font-size: 120px; --vv-offset: 0px; --app-vh: 100vh; --kb-bottom: 0px; }

*{box-sizing:border-box}
html,body{height:100%;overflow:hidden;-webkit-text-size-adjust:100%;background:#f6f7fb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#222}

.app{position:fixed;inset:0;height:calc(var(--app-vh));padding-top:var(--vv-offset);display:flex;justify-content:center}
.container{height:100%;overflow-y:auto;-webkit-overflow-scrolling:touch;max-width:1200px;margin:0 auto;padding:16px}
.card{background:#fff;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:24px;transition:padding .15s ease}
h1{margin:0 0 12px;font-size:clamp(24px,2.2vw,42px)}
input,button{font-size:16px}

.actions{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
button{border:0;border-radius:12px;background:#1a73e8;color:#fff;cursor:pointer;min-height:56px}
button.secondary{background:#e0e3eb;color:#222}
button:disabled{opacity:.6;cursor:not-allowed}
/* Desktop settings buttons bigger */
@media(min-width:1025px){ .actions button{font-size:48px;padding:1em 1.8em} }
/* Mobile settings buttons */
@media(max-width:1024px){.actions button{font-size:28px;padding:1em 2em;width:100%}}

.row{display:grid;grid-template-columns:320px 1fr;gap:14px;align-items:center;margin:12px 0}
.row label{font-size:clamp(16px,1.2vw,22px)}
.row input{width:100%;max-width:100%;border:1px solid #ddd;border-radius:12px;padding:14px;font-size:18px}
@media(max-width:680px){.row{grid-template-columns:1fr}.card{border-radius:14px;padding:16px}}

.card+.card{margin-top:16px}

/* Quiz layout */
.quiz-wrap{position:relative;display:grid;grid-template-rows:48px 1fr auto;min-height:70%}
.topbar{display:flex;align-items:center;justify-content:flex-end;padding:8px 12px}
.timer{font-size:clamp(14px,1.6vw,28px);color:#555;transition:font-size .15s ease}
.question{display:flex;align-items:center;justify-content:center;text-align:center;padding:20px 12px;transition:padding .15s ease}
.question span{font-weight:800;line-height:1.1;font-size:var(--quiz-font-size);white-space:nowrap;flex-shrink:0}

/* Answer bar fixed above keyboard */
.answer-bar{position:fixed;left:0;right:0;bottom:calc(var(--kb-bottom) + env(safe-area-inset-bottom));display:flex;justify-content:center;align-items:center;padding:16px;background:rgba(255,255,255,.95);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);border-top-left-radius:12px;border-top-right-radius:12px;box-shadow:0 -6px 18px rgba(0,0,0,.06);transition:bottom .1s ease}
.answer-bar form{display:flex;gap:18px;justify-content:center;align-items:center;width:100%}
.answer-bar input{line-height:1.05;padding:.25em .45em;min-height:1.2em;text-align:center;width:min(16ch,60%);max-width:100%}
.answer-bar button{line-height:1.05;padding:1.0em 2.2em;min-height:1.6em}

/* Mobile portrait */
@media(max-width:1024px) and (orientation:portrait){
  .question span{font-size:clamp(28px,8.5vw,80px)}
  .answer-bar input{font-size:clamp(16px,5vw,40px)}
  .answer-bar button{font-size:clamp(14px,3.8vw,24px)}
}
/* Mobile landscape */
@media(max-width:1024px) and (orientation:landscape){
  .question span{font-size:clamp(20px,6vw,48px)}
  .answer-bar input{font-size:clamp(14px,3vw,24px)}
  .answer-bar button{font-size:clamp(12px,2.6vw,14px)}
}

/* Desktop: enlarge hit targets; font sizes are JS-driven */
@media(min-width:1025px){
  .answer-bar input{
    padding: 0.8em 1em;
    border-radius: 14px;
  }
  .answer-bar button{
    padding: 1em 2.5em;
    border-radius: 18px;
    min-width: 180px;
    min-height: 80px;
  }
}

body.compact .card{padding:12px}
body.compact .question{padding:8px 6px}
body.compact .timer{font-size:14px}
body.compact .question span{font-size:36px!important}
body.compact .answer-bar input{font-size:18px!important}
body.compact .answer-bar button{font-size:12px!important;padding:.6em 1.4em}

/* Rotate guard for real mobile only */
.rotate-guard{position:fixed;inset:0;background:#000;color:#fff;display:none;align-items:center;justify-content:center;text-align:center;padding:24px;z-index:9999}
.rotate-guard h2{margin:0 0 12px;font-size:28px}
.rotate-guard p{margin:0;font-size:16px;color:#ddd}
.hidden{display:none!important}
.notice{margin-top:8px;color:#666;font-size:13px}
</style>
</head>
<body>
<div class="rotate-guard" id="rotateGuard">
  <div>
    <h2>Please rotate your device</h2>
    <p>This app only supports portrait mode.</p>
  </div>
</div>

<div class="app" id="appRoot">
  <div class="container" id="appScroll">
    <div id="settings" class="card">
      <h1>Math Quiz Settings</h1>
      <div class="row"><label>Time Limit (sec):</label><input id="tl" type="number" min="1" value="5" /></div>
      <div class="row"><label>Total Questions:</label><input id="tq" type="number" min="1" value="10" /></div>
      <div class="row"><label>Series (comma or "all"):</label><input id="series" type="text" value="all" /></div>
      <div class="row"><label>Font Size (base, px):</label><input id="fs" type="number" min="12" value="120" /></div>
      <div class="row"><label>Review Mistakes:</label><div><input id="review" type="checkbox" /><div id="reviewTip" class="notice"></div></div></div>
      <div class="actions">
        <button id="startBtn" type="button">Start Quiz</button>
        <button id="exportBtn" class="secondary" type="button">Export Results (CSV)</button>
      </div>
    </div>

    <div id="quiz" class="card hidden">
      <div class="quiz-wrap">
        <div class="topbar"><div id="timer" class="timer">Time left: 0s</div></div>
        <div class="question"><span id="qText"></span></div>
        <div class="answer-bar">
          <form id="answerForm" autocomplete="off">
            <input id="ans" type="text" inputmode="text" enterkeyhint="send"
                   autocapitalize="off" autocorrect="off" autocomplete="off" aria-label="Your answer" />
            <button id="submitBtn" type="submit">Submit</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Detect mobile devices (UA + touch + short side heuristic)
  const isMobile = () => {
    const ua = navigator.userAgent || '';
    const touch = navigator.maxTouchPoints || 0;
    const shortSide = Math.min(screen.width, screen.height);
    return /Mobi|Android|iPhone|iPad|iPod/i.test(ua) || (touch > 1 && shortSide <= 1024);
  };

  // Element refs
  const elSettings = document.getElementById('settings');
  const elQuiz = document.getElementById('quiz');
  const elStart = document.getElementById('startBtn');
  const elExport = document.getElementById('exportBtn');
  const elTL = document.getElementById('tl');
  const elTQ = document.getElementById('tq');
  const elSeries = document.getElementById('series');
  const elFS = document.getElementById('fs');
  const elReview = document.getElementById('review');
  const elReviewTip = document.getElementById('reviewTip');
  const elQText = document.getElementById('qText');
  const elAns = document.getElementById('ans');
  const elSubmit = document.getElementById('submitBtn');
  const elForm = document.getElementById('answerForm');
  const elTimer = document.getElementById('timer');
  const rotateGuard = document.getElementById('rotateGuard');

  // State
  let quizData = [], currentIndex = 0, timerId = null, timeLeft = 0, mistakes = [], lastSubmitTs = 0;
  let allowReview = false, composing = false;

  // Adjust viewport height for mobile browsers
  function applyVh(){
    const vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight);
    document.documentElement.style.setProperty('--app-vh', vh + 'px');
  }
  function onVisualViewportChange(){
    if (window.visualViewport) {
      document.documentElement.style.setProperty('--vv-offset', 0 + 'px');
    }
  }

  // Keyboard inset + compact mode (mainly for mobile)
  function updateKeyboardInset() {
    const vv = window.visualViewport;
    const ih = window.innerHeight;
    if (vv) {
      const kb = Math.max(0, ih - vv.height - (vv.offsetTop || 0));
      document.documentElement.style.setProperty('--kb-bottom', kb + 'px');
      const compact = vv.height < 380 || (window.innerWidth > window.innerHeight && vv.height < 420);
      document.body.classList.toggle('compact', compact);
    } else {
      document.documentElement.style.setProperty('--kb-bottom', '0px');
      document.body.classList.remove('compact');
    }
  }

  // Show a rotate guard for mobile landscape
  function updateRotateGuard(){
    const landscape = window.innerWidth > window.innerHeight;
    rotateGuard.style.display = (isMobile() && landscape) ? 'flex' : 'none';
  }

  // Persist settings to localStorage
  function saveSettings() {
    try{
      const s = { tl: elTL.value, tq: elTQ.value, series: elSeries.value, fs: elFS.value, allowReview, mistakes };
      localStorage.setItem('mathQuizSettings', JSON.stringify(s));
    }catch(e){}
  }

  // Load settings from localStorage
  function loadSettings() {
    try{
      const s = JSON.parse(localStorage.getItem('mathQuizSettings') || '{}');
      if (s.tl) elTL.value = s.tl;
      if (s.tq) elTQ.value = s.tq;
      if (s.series) elSeries.value = s.series;
      if (s.fs) elFS.value = s.fs;
      if (s.allowReview) { allowReview = true; elReview.checked = true; }
      if (Array.isArray(s.mistakes)) mistakes = s.mistakes;
    }catch(e){}
    document.documentElement.style.setProperty('--quiz-font-size', (parseInt(elFS.value,10)||120) + 'px');
  }

  // Generate quiz questions (multiplication)
  function generateQuiz() {
    quizData = [];
    const seriesVal = elSeries.value.trim().toLowerCase();
    let tables = [];
    if (seriesVal === 'all') tables = [...Array(9).keys()].map(i => i + 1);
    else tables = seriesVal.split(',').map(v => parseInt(v.trim(),10)).filter(v => v >= 1 && v <= 9);
    const total = Math.max(1, parseInt(elTQ.value,10) || 10);
    for (let i = 0; i < total; i++) {
      const a = tables[Math.floor(Math.random() * tables.length)];
      const b = Math.floor(Math.random() * 9) + 1;
      quizData.push({ a, b, ans: a * b });
    }
  }

  // Force input focus (helps desktop & mobile)
  function ensureFocus(fromGesture=false){
    const tryFocus = () => {
      elAns.focus({ preventScroll: true });
      if (fromGesture) { try { elAns.click(); } catch(e){} }
      try { elAns.setSelectionRange(elAns.value.length, elAns.value.length); } catch(e) {}
    };
    tryFocus();
    requestAnimationFrame(() => setTimeout(tryFocus, 0));
  }

  // Adjust font sizes based on device type and viewport height
  function adjustFontSizes() {
    const landscape = window.innerWidth > window.innerHeight;
    const h = (window.visualViewport ? window.visualViewport.height : window.innerHeight);

    let q, a, s; // question, answer input, submit button sizes

    if (isMobile()) {
      // Mobile: keep original behavior with caps
      q = landscape ? Math.min(h * 0.15, 48) : Math.min(h * 0.20, 80);
      q = Math.max(q, 28);
      a = q * 0.50;
      s = q * 0.30;
    } else {
      // Desktop: larger sizes with lower/upper bounds
      // Question: target 12vh, clamp to 80–200px
      q = Math.min(h * 0.12, 200);
      q = Math.max(q, 80);
      // Answer input: target 8vh, clamp to 60–160px
      a = Math.min(h * 0.08, 160);
      a = Math.max(a, 60);
      // Submit button: target 6vh, clamp to 40–120px
      s = Math.min(h * 0.06, 120);
      s = Math.max(s, 40);
    }

    const qEl = document.querySelector('.question span');
    const aEl = document.querySelector('.answer-bar input');
    const sEl = document.querySelector('.answer-bar button');
    if (qEl) qEl.style.fontSize = q + 'px';
    if (aEl) aEl.style.fontSize = a + 'px';
    if (sEl) sEl.style.fontSize = s + 'px';
  }

  // Render current question and start per-question timer
  function showQuestion() {
    if (currentIndex >= quizData.length) { endQuiz(); return; }
    const q = quizData[currentIndex];
    elQText.textContent = `${q.a} × ${q.b} = ?`;
    elAns.value = '';
    ensureFocus(false);
    adjustFontSizes();
    updateKeyboardInset();
    const qEl = document.querySelector('.question');
    if (qEl) qEl.scrollIntoView({block:'start',behavior:'instant'});
    timeLeft = Math.max(1, parseInt(elTL.value,10) || 5);
    elTimer.textContent = `Time left: ${timeLeft}s`;
    clearInterval(timerId);
    timerId = setInterval(() => {
      timeLeft--;
      elTimer.textContent = `Time left: ${timeLeft}s`;
      if (timeLeft <= 0) { clearInterval(timerId); submitAnswer(); }
    }, 1000);
  }

  // Submit current answer; log mistakes; advance
  function submitAnswer(){
    const now = performance.now();
    if (now - lastSubmitTs < 250) return; // prevent double-submit
    lastSubmitTs = now;
    const q = quizData[currentIndex];
    const userAns = elAns.value.trim();
    const correctAns = String(q.ans);
    if (userAns !== correctAns) mistakes.push(q);
    currentIndex++;
    showQuestion();
    ensureFocus(true);
  }

  // Start quiz (either fresh or review mistakes)
  function startQuiz() {
    document.documentElement.style.setProperty('--quiz-font-size', (parseInt(elFS.value,10)||120) + 'px');
    if (elReview.checked && allowReview && mistakes.length) quizData = [...mistakes];
    else generateQuiz();
    currentIndex = 0;
    mistakes = [];
    elSettings.classList.add('hidden');
    elQuiz.classList.remove('hidden');
    showQuestion();
  }

  // End quiz; allow review; show alert if perfect
  function endQuiz() {
    clearInterval(timerId);
    allowReview = true;
    saveSettings();
    if (mistakes.length === 0) alert('Perfect! All answers correct.');
    elSettings.classList.remove('hidden');
    elQuiz.classList.add('hidden');
  }

  // Submission plumbing & IME handling
  elAns.addEventListener('compositionstart', () => { composing = true; });
  elAns.addEventListener('compositionend',   () => { composing = false; });

  elForm.addEventListener('submit', (e) => { e.preventDefault(); if (!composing) submitAnswer(); });
  elAns.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !composing){ e.preventDefault(); submitAnswer(); } });
  elAns.addEventListener('beforeinput', (e) => { if (e.inputType === 'insertLineBreak' && !composing){ e.preventDefault(); submitAnswer(); } });
  const trigger = (e)=>{ e && e.preventDefault && e.preventDefault(); if (!composing) submitAnswer(); };
  elSubmit.addEventListener('click', trigger);
  elSubmit.addEventListener('touchend', trigger, {passive:false});

  // Export results (CSV) — preserved from original
  elExport.addEventListener('click', () => {
    const header = ['a','b','ans'].join(',');
    const rows = mistakes.map(m => [m.a,m.b,m.ans].join(','));
    const csv = [header, ...rows].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
    a.href = url;
    a.download = `math-quiz-mistakes-${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // Settings + start
  elStart.addEventListener('click', startQuiz);

  // App init
  function init(){
    applyVh(); onVisualViewportChange();
    adjustFontSizes(); updateKeyboardInset(); updateRotateGuard();
    loadSettings();
  }
  document.addEventListener('DOMContentLoaded', init);

  // Resize/orientation/visualViewport listeners
  window.addEventListener('resize', () => { applyVh(); adjustFontSizes(); updateKeyboardInset(); updateRotateGuard(); });
  window.addEventListener('orientationchange', () => { setTimeout(()=>{ applyVh(); adjustFontSizes(); updateKeyboardInset(); updateRotateGuard(); }, 50); });
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', () => { applyVh(); adjustFontSizes(); updateKeyboardInset(); }, {passive:true});
    window.visualViewport.addEventListener('scroll',  () => { onVisualViewportChange(); updateKeyboardInset(); }, {passive:true});
  }
})();
</script>
</body>
</html>
