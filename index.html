<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Math Quiz</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1a73e8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
:root { --quiz-font-size: 120px; --vv-offset: 0px; --app-vh: 100vh; --kb-bottom: 0px; }
*, *::before, *::after { box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; overscroll-behavior: contain; -webkit-text-size-adjust: 100%; background: #f6f7fb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#222; }
.app { position: fixed; inset: 0; height: 100svh; height: calc(var(--app-vh)); padding-top: var(--vv-offset); display: flex; justify-content: center; }
.container { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; max-width: 960px; margin: 0 auto; padding: 16px; }
.card { background:#fff; border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,.08); padding:20px; transition: padding .15s ease; }
h1 { margin:0 0 12px; font-size:clamp(22px,3.2vw,36px); }
input, textarea, select, button { font-size: 16px; }

/* ---------- Settings page ---------- */
.actions { display:flex; gap:12px; margin-top:12px; flex-wrap: wrap; }
button { border:0; border-radius:12px; background:#1a73e8; color:#fff; cursor:pointer; min-height:44px; }
button.secondary { background:#e0e3eb; color:#222; }
button:disabled { opacity:.6; cursor:not-allowed; }
/* Desktop: bigger buttons on settings */
.actions button { font-size: 40px; padding: 0.8em 1.5em; }
/* Mobile settings overrides */
@media (max-width: 768px) {
  .actions button { font-size: 28px; padding: 1em 2em; width: 100%; }
}

/* Inputs */
.row { display:grid; grid-template-columns:260px 1fr; gap:12px; align-items:center; margin:10px 0; }
.row label { font-size: clamp(14px, 1.4vw, 20px); }
.row input { width:100%; max-width:100%; border:1px solid #ddd; border-radius:12px; padding:12px; }
@media (max-width: 680px) { .row { grid-template-columns: 1fr; } .card { border-radius:14px; padding:16px; } }

.card + .card { margin-top: 16px; }

/* ---------- Quiz page ---------- */
.quiz-wrap { position:relative; min-height:70%; display:grid; grid-template-rows:auto 1fr auto; }
.timer { position:absolute; top:10px; right:12px; font-size: clamp(14px, 2vw, 28px); color:#555; transition: font-size .15s ease; }
.question { display:flex; align-items:center; justify-content:center; text-align:center; padding:28px 12px; transition: padding .15s ease; }
.question span { font-weight:800; line-height:1.1; font-size: var(--quiz-font-size); white-space: nowrap; flex-shrink: 0; }

/* Keyboard-aware answer bar: fixed + bottom inset var */
.answer-bar { position: fixed; left:0; right:0; bottom: calc(var(--kb-bottom) + env(safe-area-inset-bottom)); display:flex; justify-content:center; align-items:center; padding:14px; background:rgba(255,255,255,.95); -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px); border-top-left-radius:12px; border-top-right-radius:12px; box-shadow:0 -6px 18px rgba(0,0,0,.06); transition: bottom .1s ease; }
.answer-bar form { display:flex; gap:16px; justify-content:center; align-items:center; width:100%; }
.answer-bar input { line-height:1.05; padding:0.2em 0.35em; min-height:1.2em; text-align:center; width:min(12ch,60%); max-width:100%; }
.answer-bar button { line-height:1.05; padding:0.9em 2.0em; min-height:1.4em; }

/* Mobile portrait caps */
@media (max-width: 768px) and (orientation: portrait) {
  .question span { font-size: clamp(28px, 8.5vw, 80px); }
  .answer-bar input { font-size: clamp(16px, 5vw, 40px); }
  .answer-bar button { font-size: clamp(14px, 3.8vw, 24px); }
}

/* Mobile landscape caps */
@media (max-width: 1024px) and (orientation: landscape) {
  .question span { font-size: clamp(20px, 6vw, 48px); }
  .answer-bar input { font-size: clamp(14px, 3vw, 24px); }
  .answer-bar button { font-size: clamp(12px, 2.6vw, 14px); }
}

/* Compact mode */
body.compact .card { padding:12px; }
body.compact .question { padding:8px 6px; }
body.compact .timer { font-size:14px; top:6px; right:8px; }
body.compact .question span { font-size: 36px !important; }
body.compact .answer-bar input  { font-size: 18px !important; }
body.compact .answer-bar button { font-size: 12px !important; padding: 0.6em 1.4em; }

/* Portrait-only overlay for browsers that can't lock */
.rotate-overlay {
  position: fixed; inset: 0; background: #0b1324; color:#fff; display: none; align-items:center; justify-content:center; text-align:center; padding: 24px; z-index: 9999;
}
.rotate-overlay.show { display: flex; }
.rotate-overlay h2 { margin: 0 0 8px; font-size: 24px; }
.rotate-overlay p  { margin: 0; opacity: .8; }
</style>
</head>
<body>
  <div class="rotate-overlay" id="rotateOverlay">
    <div>
      <h2>Please rotate your device</h2>
      <p>This app works in portrait mode only.</p>
    </div>
  </div>

  <div class="app" id="appRoot">
    <div class="container" id="appScroll">
      <div id="settings" class="card">
        <h1>Math Quiz Settings</h1>
        <div class="row"><label>Time Limit (sec):</label><input id="tl" type="number" min="1" value="5" /></div>
        <div class="row"><label>Total Questions:</label><input id="tq" type="number" min="1" value="10" /></div>
        <div class="row"><label>Series (comma or "all"):</label><input id="series" type="text" value="all" /></div>
        <div class="row"><label>Font Size (base, px):</label><input id="fs" type="number" min="12" value="120" /></div>
        <div class="row"><label>Review Mistakes:</label><div><input id="review" type="checkbox" /><div id="reviewTip" class="notice"></div></div></div>
        <div class="actions">
          <button id="startBtn" type="button">Start Quiz</button>
          <button id="exportBtn" class="secondary" type="button">Export Results (CSV)</button>
        </div>
      </div>
      <div id="quiz" class="card hidden">
        <div class="quiz-wrap">
          <div id="timer" class="timer">Time left: 0s</div>
          <div class="question"><span id="qText"></span></div>
          <div class="answer-bar">
            <form id="answerForm" autocomplete="off">
              <input id="ans" type="text" inputmode="text" enterkeyhint="send"
                     autocapitalize="off" autocorrect="off" autocomplete="off" aria-label="Your answer" />
              <button id="submitBtn" type="submit">Submit</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const elSettings = document.getElementById('settings');
  const elQuiz = document.getElementById('quiz');
  const elStart = document.getElementById('startBtn');
  const elExport = document.getElementById('exportBtn');
  const elTL = document.getElementById('tl');
  const elTQ = document.getElementById('tq');
  const elSeries = document.getElementById('series');
  const elFS = document.getElementById('fs');
  const elReview = document.getElementById('review');
  const elReviewTip = document.getElementById('reviewTip');
  const elQText = document.getElementById('qText');
  const elAns = document.getElementById('ans');
  const elSubmit = document.getElementById('submitBtn');
  const elForm = document.getElementById('answerForm');
  const elTimer = document.getElementById('timer');
  const overlay = document.getElementById('rotateOverlay');
  const scroller = document.getElementById('appScroll');

  let quizData = [], currentIndex = 0, timerId = null, timeLeft = 0, mistakes = [], lastSubmitTs = 0;
  let allowReview = false, composing = false;

  /* ===== orientation lock (where supported) ===== */
  function tryLockPortrait() {
    const anyNav = /** @type {any} */ (navigator);
    if (screen.orientation && screen.orientation.lock) {
      screen.orientation.lock('portrait').catch(()=>{});
    } else if (anyNav && anyNav.lockOrientation) {
      try { anyNav.lockOrientation('portrait'); } catch(e) {}
    }
  }

  function toggleOverlay() {
    const isLandscape = window.innerWidth > window.innerHeight;
    overlay.classList.toggle('show', isLandscape);
  }

  /* ===== viewport height stabilization (iOS) ===== */
  function applyVh(){
    const vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight);
    document.documentElement.style.setProperty('--app-vh', vh + 'px');
  }
  function onVisualViewportChange(){
    // In iOS standalone PWA, offsetTop is usually 0 (no URL bar)
    const off = (window.visualViewport ? (window.navigator.standalone ? 0 : (window.visualViewport.offsetTop || 0)) : 0);
    document.documentElement.style.setProperty('--vv-offset', off + 'px');
  }
  applyVh(); onVisualViewportChange();
  window.addEventListener('resize', applyVh);
  if (window.visualViewport) {
    window.visualViewport.addEventListener('resize', () => { applyVh(); onVisualViewportChange(); adjustFontSizes(); updateKeyboardInset(); }, {passive:true});
    window.visualViewport.addEventListener('scroll',  () => { onVisualViewportChange(); updateKeyboardInset(); }, {passive:true});
  }

  /* ===== dynamic font sizing by available height ===== */
  function adjustFontSizes() {
    const isLandscape = window.innerWidth > window.innerHeight;
    const h = (window.visualViewport ? window.visualViewport.height : window.innerHeight);
    let q = isLandscape ? h * 0.15 : h * 0.20;
    q = Math.min(q, isLandscape ? 44 : 80);
    q = Math.max(q, 20);
    const a = q * 0.50;
    const s = q * 0.30;
    const qEl = document.querySelector('.question span');
    const aEl = document.querySelector('.answer-bar input');
    const sEl = document.querySelector('.answer-bar button');
    if (qEl) qEl.style.fontSize = q + 'px';
    if (aEl) aEl.style.fontSize = a + 'px';
    if (sEl) sEl.style.fontSize = s + 'px';
  }

  /* ===== keyboard-aware layout ===== */
  function updateKeyboardInset() {
    const vv = window.visualViewport;
    const ih = window.innerHeight;
    if (vv) {
      const kb = Math.max(0, ih - vv.height - (vv.offsetTop || 0));
      document.documentElement.style.setProperty('--kb-bottom', kb + 'px');
      const compact = vv.height < 380 || (window.innerWidth > window.innerHeight && vv.height < 420);
      document.body.classList.toggle('compact', compact);
      const q = document.querySelector('.question');
      if (q) q.scrollIntoView({ block: 'start', behavior: 'instant' });
    } else {
      document.documentElement.style.setProperty('--kb-bottom', '0px');
      document.body.classList.remove('compact');
    }
  }

  window.addEventListener('resize', () => { adjustFontSizes(); updateKeyboardInset(); toggleOverlay(); });
  window.addEventListener('orientationchange', () => { setTimeout(() => { adjustFontSizes(); updateKeyboardInset(); toggleOverlay(); tryLockPortrait(); }, 50); });
  document.addEventListener('DOMContentLoaded', () => { adjustFontSizes(); updateKeyboardInset(); toggleOverlay(); tryLockPortrait(); });

  /* ===== settings persistence ===== */
  function saveSettings() {
    const s = { tl: elTL.value, tq: elTQ.value, series: elSeries.value, fs: elFS.value, allowReview, mistakes };
    localStorage.setItem('mathQuizSettings', JSON.stringify(s));
  }
  function loadSettings() {
    const s = JSON.parse(localStorage.getItem('mathQuizSettings') || '{}');
    if (s.tl) elTL.value = s.tl;
    if (s.tq) elTQ.value = s.tq;
    if (s.series) elSeries.value = s.series;
    if (s.fs) elFS.value = s.fs;
    if (s.allowReview) { allowReview = true; elReview.checked = true; }
    if (Array.isArray(s.mistakes)) mistakes = s.mistakes;
    document.documentElement.style.setProperty('--quiz-font-size', (parseInt(elFS.value,10)||120) + 'px');
  }

  /* ===== quiz generation ===== */
  function generateQuiz() {
    quizData = [];
    const seriesVal = elSeries.value.trim().toLowerCase();
    let tables = [];
    if (seriesVal === 'all') tables = [...Array(9).keys()].map(i => i + 1);
    else tables = seriesVal.split(',').map(v => parseInt(v.trim(),10)).filter(v => v >= 1 && v <= 9);
    const total = Math.max(1, parseInt(elTQ.value,10) || 10);
    for (let i = 0; i < total; i++) {
      const a = tables[Math.floor(Math.random() * tables.length)];
      const b = Math.floor(Math.random() * 9) + 1;
      quizData.push({ a, b, ans: a * b });
    }
  }

  /* ===== focus helper ===== */
  function ensureFocus(fromGesture=false){
    const tryFocus = () => {
      elAns.focus({ preventScroll: true });
      if (fromGesture) { try { elAns.click(); } catch(e){} }
      try { elAns.setSelectionRange(elAns.value.length, elAns.value.length); } catch(e) {}
    };
    tryFocus();
    requestAnimationFrame(() => setTimeout(tryFocus, 0));
  }

  /* ===== quiz flow ===== */
  function showQuestion() {
    if (currentIndex >= quizData.length) { endQuiz(); return; }
    const q = quizData[currentIndex];
    elQText.textContent = `${q.a} × ${q.b} = ?`;
    elAns.value = '';
    ensureFocus(false);
    adjustFontSizes();
    updateKeyboardInset();
    timeLeft = Math.max(1, parseInt(elTL.value,10) || 5);
    elTimer.textContent = `Time left: ${timeLeft}s`;
    clearInterval(timerId);
    timerId = setInterval(() => {
      timeLeft--;
      elTimer.textContent = `Time left: ${timeLeft}s`;
      if (timeLeft <= 0) { clearInterval(timerId); submitAnswer(); }
    }, 1000);
  }

  function submitAnswer(){
    const now = performance.now();
    if (now - lastSubmitTs < 250) return; // de-dupe
    lastSubmitTs = now;

    const q = quizData[currentIndex];
    const userAns = elAns.value.trim();
    const correctAns = String(q.ans);
    if (userAns !== correctAns) mistakes.push(q);
    currentIndex++;
    showQuestion();
    ensureFocus(true);
  }

  function startQuiz() {
    document.documentElement.style.setProperty('--quiz-font-size', (parseInt(elFS.value,10)||120) + 'px');
    if (elReview.checked && allowReview && mistakes.length) quizData = [...mistakes];
    else generateQuiz();
    currentIndex = 0;
    mistakes = [];
    elSettings.classList.add('hidden');
    elQuiz.classList.remove('hidden');
    scroller.scrollTo({top:0, behavior:'instant'});
    showQuestion();
  }

  function endQuiz() {
    clearInterval(timerId);
    allowReview = true;
    saveSettings();
    if (mistakes.length === 0) {
      alert('Perfect! All answers correct.');
    } else {
      elReviewTip.textContent = `You had ${mistakes.length} mistake(s) last round.`;
    }
    elSettings.classList.remove('hidden');
    elQuiz.classList.add('hidden');
  }

  /* ===== IME-safe submit (iOS/Android) ===== */
  elAns.addEventListener('compositionstart', () => { composing = true; });
  elAns.addEventListener('compositionend',   () => { composing = false; });

  // iOS PWA sometimes misses keydown/submit. beforeinput with insertLineBreak is the most reliable.
  elAns.addEventListener('beforeinput', (e) => {
    if (e.inputType === 'insertLineBreak' && !composing) {
      e.preventDefault();
      submitAnswer();
    }
  });

  elForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (!composing) submitAnswer();
  });

  const trigger = (e)=>{ e && e.preventDefault && e.preventDefault(); if (!composing) submitAnswer(); };
  elSubmit.addEventListener('click', trigger);
  elSubmit.addEventListener('touchend', trigger, {passive:false});

  // Allow Enter on all devices
  elAns.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !composing) {
      e.preventDefault();
      submitAnswer();
    }
  });

  elStart.addEventListener('click', () => { tryLockPortrait(); startQuiz(); ensureFocus(true); });
  elExport.addEventListener('click', () => {
    if(!quizData.length){ alert('No data to export.'); return; }
    const rows = [['A','B','Answer'], ...quizData.map(q=>[q.a,q.b,q.ans])];
    const csv = rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'quiz_results.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  loadSettings();

  // SW registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }
})();
</script>
</body>
</html>
