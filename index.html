<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Math Quiz</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1a73e8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
:root { --quiz-font-size: 120px; }
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f0f0; }
.container { max-width: 600px; margin: auto; padding: 20px; }
.hidden { display: none; }
.question { font-size: var(--quiz-font-size); text-align: center; margin: 20px 0; }
.answer-bar { display: flex; justify-content: center; gap: 10px; }
.answer-bar input { font-size: var(--quiz-font-size); text-align: center; width: 50%; }
.answer-bar button { font-size: calc(var(--quiz-font-size) * 0.5); }
.timer { text-align: right; margin-bottom: 10px; font-size: 1.5em; }
</style>
</head>
<body>
<div class="container">
  <div id="settings">
    <h1>Math Quiz Settings</h1>
    <label>Time Limit (sec): <input id="tl" type="number" value="5"></label><br><br>
    <label>Total Questions: <input id="tq" type="number" value="10"></label><br><br>
    <label>Series (comma or 'all'): <input id="series" type="text" value="all"></label><br><br>
    <label>Font Size: <input id="fs" type="number" value="120"></label><br><br>
    <label><input id="review" type="checkbox"> Review Mistakes</label><br><br>
    <button id="startBtn">Start Quiz</button>
    <button id="exportBtn">Export Results (CSV)</button>
    <div id="reviewTip" style="color:gray; font-size:0.9em;"></div>
  </div>
  <div id="quiz" class="hidden">
    <div class="timer" id="timer">Time left: 0s</div>
    <div class="question" id="qText"></div>
    <div class="answer-bar">
      <input id="ans" type="text" autocomplete="off" autocorrect="off" autocapitalize="off">
      <button id="submitBtn">Submit</button>
    </div>
  </div>
</div>
<script>
const elSettings = document.getElementById('settings');
const elQuiz = document.getElementById('quiz');
const elStart = document.getElementById('startBtn');
const elExport = document.getElementById('exportBtn');
const elTL = document.getElementById('tl');
const elTQ = document.getElementById('tq');
const elSeries = document.getElementById('series');
const elFS = document.getElementById('fs');
const elReview = document.getElementById('review');
const elReviewTip = document.getElementById('reviewTip');
const elQText = document.getElementById('qText');
const elAns = document.getElementById('ans');
const elSubmit = document.getElementById('submitBtn');
const elTimer = document.getElementById('timer');
let quizData = [], currentIndex = 0, timerId = null, timeLeft = 0, mistakes = [];
let allowReview = false;

function saveSettings() {
  const s = { tl: elTL.value, tq: elTQ.value, series: elSeries.value, fs: elFS.value, allowReview, mistakes };
  localStorage.setItem('mathQuizSettings', JSON.stringify(s));
}

function loadSettings() {
  const s = JSON.parse(localStorage.getItem('mathQuizSettings') || '{}');
  if (s.tl) elTL.value = s.tl;
  if (s.tq) elTQ.value = s.tq;
  if (s.series) elSeries.value = s.series;
  if (s.fs) elFS.value = s.fs;
  if (s.allowReview) { allowReview = true; elReview.checked = true; }
  if (Array.isArray(s.mistakes)) mistakes = s.mistakes;
}

function generateQuiz() {
  quizData = [];
  const seriesVal = elSeries.value.trim().toLowerCase();
  let tables = [];
  if (seriesVal === 'all') tables = [...Array(9).keys()].map(i => i + 1);
  else tables = seriesVal.split(',').map(v => parseInt(v.trim())).filter(v => v >= 1 && v <= 9);
  for (let i = 0; i < parseInt(elTQ.value); i++) {
    const a = tables[Math.floor(Math.random() * tables.length)];
    const b = Math.floor(Math.random() * 9) + 1;
    quizData.push({ a, b, ans: a * b });
  }
}

function showQuestion() {
  if (currentIndex >= quizData.length) { endQuiz(); return; }
  const q = quizData[currentIndex];
  elQText.textContent = `${q.a} Ã— ${q.b} = ?`;
  elAns.value = '';
  elAns.focus({ preventScroll: true });
  timeLeft = parseInt(elTL.value);
  elTimer.textContent = `Time left: ${timeLeft}s`;
  clearInterval(timerId);
  timerId = setInterval(() => {
    timeLeft--;
    elTimer.textContent = `Time left: ${timeLeft}s`;
    if (timeLeft <= 0) { clearInterval(timerId); checkAnswer(); }
  }, 1000);
}

function checkAnswer() {
  const userAns = elAns.value.trim();
  const correctAns = quizData[currentIndex].ans.toString();
  if (userAns !== correctAns) mistakes.push(quizData[currentIndex]);
  currentIndex++;
  showQuestion();
}

function startQuiz() {
  if (elReview.checked && !allowReview) return;
  document.documentElement.style.setProperty('--quiz-font-size', elFS.value + 'px');
  if (elReview.checked && mistakes.length) quizData = [...mistakes];
  else generateQuiz();
  currentIndex = 0;
  mistakes = [];
  elSettings.classList.add('hidden');
  elQuiz.classList.remove('hidden');
  showQuestion();
}

function endQuiz() {
  clearInterval(timerId);
  allowReview = true;
  saveSettings();
  if (mistakes.length === 0) {
    alert('Perfect! All answers correct.');
    window.close();
  } else {
    elSettings.classList.remove('hidden');
    elQuiz.classList.add('hidden');
    elReviewTip.textContent = `You had ${mistakes.length} mistake(s) last round.`;
  }
}

elStart.addEventListener('click', startQuiz);
elSubmit.addEventListener('click', checkAnswer);
elAns.addEventListener('keydown', e => { if (e.key === 'Enter') checkAnswer(); });

loadSettings();
</script>
</body>
</html>
