<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Math Quiz</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1a73e8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root {
      --quiz-font-size: 120px;   /* desktop master size for question + answer input */
      --vv-offset: 0px;
      --app-vh: 100vh;
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      height: 100%;
      overflow: hidden;
      overscroll-behavior: contain;
      -webkit-text-size-adjust: 100%;
      background: #f6f7fb;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #222;
    }

    .app { position: fixed; inset: 0; height: 100svh; height: calc(var(--app-vh));
      transform: translateY(calc(-1 * var(--vv-offset))); display: flex; justify-content: center; }
    .container { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; max-width: 960px; margin: 0 auto; padding: 16px; }

    .card { background:#fff; border-radius:16px; box-shadow:0 6px 24px rgba(0,0,0,.08); padding:20px; }
    h1    { margin:0 0 12px; font-size:clamp(22px,3.2vw,36px); }

    /* Baseline >=16px to avoid iOS zoom */
    input, textarea, select, button { font-size: 16px; }

    .row { display:grid; grid-template-columns:260px 1fr; gap:12px; align-items:center; margin:10px 0; }
    .row label { font-size: clamp(14px, 1.4vw, 20px); }
    .row input { width:100%; max-width:100%; border:1px solid #ddd; border-radius:12px; padding:12px; }

    .actions { display:flex; gap:12px; margin-top:12px; flex-wrap: wrap; }
    button { padding:14px 18px; border:0; border-radius:12px; background:#1a73e8; color:#fff; cursor:pointer; min-height:44px; }
    button.secondary { background:#e0e3eb; color:#222; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .card + .card { margin-top: 16px; }
    .quiz-wrap { position:relative; min-height:70%; display:grid; grid-template-rows:auto 1fr auto; }
    .timer     { position:absolute; top:10px; right:12px; font-size: clamp(14px, 2vw, 28px); color:#555; }
    .question  { display:flex; align-items:center; justify-content:center; text-align:center; padding:28px 12px; }
    .question span { font-weight:800; line-height:1.1; font-size: var(--quiz-font-size) !important; white-space: nowrap; flex-shrink: 0; }

    .answer-bar { position: sticky; bottom: 0; display:flex; gap:16px; justify-content:center; align-items:center;
      padding:14px; background:rgba(255,255,255,.9); -webkit-backdrop-filter: blur(6px); backdrop-filter: blur(6px);
      border-top-left-radius:12px; border-top-right-radius:12px; }

    /* Desktop: Input = question; Button = 50% of question */
    .answer-bar input { font-size: var(--quiz-font-size) !important; line-height:1.05; padding:0.2em 0.35em; min-height:1.2em; text-align:center;
      width:min(12ch,60%); max-width:100%; }
    .answer-bar button { font-size: calc(var(--quiz-font-size) * 0.5) !important; line-height:1.05; padding:0.3em 0.8em; min-height:1.4em; }

    /* Mobile (<=768px): Question 50%, Input 25%, Submit 16% */
    @media (max-width: 768px) {
      .question span { font-size: clamp(32px, 10vw, calc(var(--quiz-font-size) * 0.5)) !important; }
      .answer-bar input { font-size: clamp(20px, 6vw, calc(var(--quiz-font-size) * 0.25)) !important; }
      .answer-bar button { font-size: clamp(14px, 3.5vw, calc(var(--quiz-font-size) * 0.16)) !important; }
    }

    .hidden { display:none !important; }
    .notice { margin-top:8px; color:#666; font-size:13px; }
    @media (max-width: 680px) { .row { grid-template-columns: 1fr; } .actions button { width: 100%; } .card { border-radius:14px; padding:16px; } }
  </style>
</head>
<body>
  <div class="app" id="appRoot">
    <div class="container" id="appScroll">
      <div id="settings" class="card">
        <h1>Math Quiz Settings</h1>
        <div class="row"><label>Time Limit (sec):</label><input id="tl" type="number" min="1" value="5" inputmode="numeric" /></div>
        <div class="row"><label>Total Questions:</label><input id="tq" type="number" min="1" value="10" inputmode="numeric" /></div>
        <div class="row"><label>Series (comma or "all"):</label><input id="series" type="text" value="all" placeholder="e.g. 2,3,5 or all" /></div>
        <div class="row"><label>Font Size:</label><input id="fs" type="number" min="12" value="120" inputmode="numeric" /></div>
        <div class="row"><label>Review Mistakes:</label><div><input id="review" type="checkbox" /><div id="reviewTip" class="notice"></div></div></div>
        <div class="actions">
          <button id="startBtn" type="button">Start Quiz</button>
          <button id="exportBtn" class="secondary" type="button">Export Results (CSV)</button>
        </div>
      </div>

      <div id="quiz" class="card hidden">
        <div class="quiz-wrap">
          <div id="timer" class="timer">Time left: 0s</div>
          <div class="question"><span id="qText"></span></div>
          <div class="answer-bar">
            <!-- 不強制數字鍵盤；仍可輸入數字，並由程式過濾非數字 -->
            <input id="ans"
                   type="text" inputmode="text" enterkeyhint="done"
                   autocapitalize="off" autocorrect="off" autocomplete="off"
                   aria-label="Your answer" />
            <button id="submitBtn" type="button">Submit</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(()=>{
/* ===== LocalStorage keys ===== */
const LS_SETTINGS_KEY = 'mq_settings_v1';
const LS_MISTAKES_KEY = 'mq_mistakes_v1';

/* ===== State ===== */
const state = {
  firstRunFinished:false, wrongQuestions:[], results:[],
  questions:[], idx:0, timeLimit:5, timerId:null, timeLeft:0,
  allCorrect:true, isReview:false, fontSize:120
};

/* ===== Elements ===== */
const scroller  = document.getElementById('appScroll');
const elSettings= document.getElementById('settings');
const elQuiz    = document.getElementById('quiz');
const elTL      = document.getElementById('tl');
const elTQ      = document.getElementById('tq');
const elSeries  = document.getElementById('series');
const elFS      = document.getElementById('fs');
const elReview  = document.getElementById('review');
const elReviewTip=document.getElementById('reviewTip');
const elStart   = document.getElementById('startBtn');
const elExport  = document.getElementById('exportBtn');
const elQText   = document.getElementById('qText');
const elTimer   = document.getElementById('timer');
const elAns     = document.getElementById('ans');
const elSubmit  = document.getElementById('submitBtn');

/* ===== Env detection ===== */
const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)
                 || window.matchMedia('(pointer:coarse)').matches;

/* ===== Utils ===== */
const clampQ = px => Math.min(120, Math.max(12, px));
const setView = showQuiz => {
  elSettings.classList.toggle('hidden', showQuiz);
  elQuiz.classList.toggle('hidden', !showQuiz);
  scroller.scrollTo({top: 0, behavior: 'instant'});
};

/* iOS no-jump viewport handling */
function applyVh(){
  const vh = (window.visualViewport ? window.visualViewport.height : window.innerHeight);
  document.documentElement.style.setProperty('--app-vh', vh + 'px');
}
function onVisualViewportChange(){
  if (window.visualViewport) {
    const off = window.visualViewport.offsetTop || 0;
    document.documentElement.style.setProperty('--vv-offset', off + 'px');
  }
}
applyVh(); onVisualViewportChange();
window.addEventListener('resize', applyVh);
if (window.visualViewport) {
  window.visualViewport.addEventListener('resize', () => { applyVh(); onVisualViewportChange(); }, {passive:true});
  window.visualViewport.addEventListener('scroll',  () => { onVisualViewportChange(); }, {passive:true});
}

/* ===== Settings load/save ===== */
function loadSettings(){
  try{
    const raw = localStorage.getItem(LS_SETTINGS_KEY);
    if(!raw) return;
    const s = JSON.parse(raw);
    if (typeof s.timeLimit === 'number') elTL.value = s.timeLimit;
    if (typeof s.total === 'number')     elTQ.value = s.total;
    if (typeof s.series === 'string')    elSeries.value = s.series;
    if (typeof s.fontSize === 'number')  elFS.value = s.fontSize;
    if (typeof s.review === 'boolean')   elReview.checked = s.review;
    const fs = clampQ(parseInt(elFS.value,10) || 120);
    document.documentElement.style.setProperty('--quiz-font-size', fs + 'px');
  }catch(e){ console.warn('loadSettings error', e); }
}
function saveSettings(){
  const s = {
    timeLimit: Math.max(1, parseInt(elTL.value,10) || 5),
    total:     Math.max(1, parseInt(elTQ.value,10) || 10),
    series:    String(elSeries.value || 'all'),
    fontSize:  clampQ(parseInt(elFS.value,10) || 120),
    review:    !!elReview.checked
  };
  localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(s));
}
['input','change'].forEach(evt=>{
  elTL.addEventListener(evt, saveSettings);
  elTQ.addEventListener(evt, saveSettings);
  elSeries.addEventListener(evt, saveSettings);
  elFS.addEventListener(evt, e=>{
    saveSettings();
    const fs = clampQ(parseInt(elFS.value,10) || 120);
    document.documentElement.style.setProperty('--quiz-font-size', fs + 'px');
  });
  elReview.addEventListener(evt, saveSettings);
});

/* ===== Mistakes persistence ===== */
function loadMistakes(){
  try{
    const raw = localStorage.getItem(LS_MISTAKES_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) return arr.filter(x => Array.isArray(x) && x.length===2);
  }catch(e){ console.warn('loadMistakes error', e); }
  return [];
}
function saveMistakes(arr){ try{ localStorage.setItem(LS_MISTAKES_KEY, JSON.stringify(arr)); }catch(e){} }
function clearMistakes(){ try{ localStorage.removeItem(LS_MISTAKES_KEY); }catch(e){} }

function refreshReview(){
  const storedMistakes = loadMistakes();
  const count = storedMistakes.length;
  if(!state.firstRunFinished && count===0){
    elReview.disabled = true;
    elReviewTip.textContent = 'Review is available after your first quiz.';
  } else if(count===0){
    elReview.disabled = true;
    elReviewTip.textContent = 'No mistakes to review.';
  } else {
    elReview.disabled = false;
    elReviewTip.textContent = `Review ${count} mistake(s) from the last session.`;
  }
}

/* ===== Focus helpers (iOS + Android + Desktop) ===== */
function ensureMobileKeyboard(el, fromGesture=false){
  const tryFocus = () => {
    el.focus({ preventScroll: true });
    if (fromGesture) { try { el.click(); } catch(e){} } // only inside user gesture
    try { el.setSelectionRange(el.value.length, el.value.length); } catch(e) {}
  };
  tryFocus();
  requestAnimationFrame(() => setTimeout(tryFocus, 0)); // post-layout retry
}

/* ===== Input filtering（僅保留數字；不強制數字鍵盤） ===== */
const MAX_LEN = 6;
elAns.addEventListener('input', () => {
  let v = elAns.value.replace(/\D+/g, '');
  if (MAX_LEN) v = v.slice(0, MAX_LEN);
  if (elAns.value !== v) elAns.value = v;
});

/* ===== Avoid button stealing focus ===== */
['pointerdown','mousedown','touchstart'].forEach(ev=>{
  elSubmit.addEventListener(ev, e => e.preventDefault());
});

/* ===== Quiz logic ===== */
function makeQuestions(total, seriesText){
  const seriesNums = [];
  if(String(seriesText).trim().toLowerCase()==='all'){
    for(let i=1;i<=9;i++) seriesNums.push(i);
  } else {
    for(const s of String(seriesText).split(',')){
      const n=parseInt(s.trim(),10);
      if(n>=1 && n<=9) seriesNums.push(n);
    }
    if(!seriesNums.length) for(let i=1;i<=9;i++) seriesNums.push(i);
  }
  const qs=[];
  for(let i=0;i<total;i++){
    const a=seriesNums[Math.floor(Math.random()*seriesNums.length)];
    const b=Math.floor(Math.random()*9)+1;
    qs.push([a,b]);
  }
  return qs;
}

function startTimer(){
  clearInterval(state.timerId);
  state.timeLeft = state.timeLimit;
  elTimer.textContent = `Time left: ${state.timeLeft}s`;
  state.timerId = setInterval(() => {
    state.timeLeft--;
    elTimer.textContent = `Time left: ${state.timeLeft}s`;
    if(state.timeLeft <= 0){
      clearInterval(state.timerId);
      onTimeout();
    }
  }, 1000);
}

function showQuestion(){
  if(state.idx >= state.questions.length) return endQuiz();
  const [a,b] = state.questions[state.idx];
  elQText.textContent = `${a} × ${b}`;
  startTimer();
  elAns.value = '';
  // keep focus every question; on mobile we try to keep keyboard up
  requestAnimationFrame(() => setTimeout(() => ensureMobileKeyboard(elAns, false), 0));
}

function onSubmit(){
  if(state.idx >= state.questions.length) return;
  const [a,b] = state.questions[state.idx];
  const correct = a*b;
  const raw = elAns.value.trim();
  const val = parseInt(raw,10);

  if(!Number.isFinite(val)){
    state.results.push([a,b,correct,raw,'Invalid']);
    if(!state.isReview) state.wrongQuestions.push([a,b]);
    state.allCorrect = false;
  } else if(val === correct){
    state.results.push([a,b,correct,String(val),'OK']);
  } else {
    state.results.push([a,b,correct,String(val),'Wrong']);
    if(!state.isReview) state.wrongQuestions.push([a,b]);
    state.allCorrect = false;
  }
  state.idx++;
  showQuestion();
  // inside gesture: safe to refocus (mobile)
  ensureMobileKeyboard(elAns, true);
}

function onTimeout(){
  if(state.idx >= state.questions.length) return;
  const [a,b] = state.questions[state.idx];
  const correct = a*b;
  state.results.push([a,b,correct,'','Timeout']);
  if(!state.isReview) state.wrongQuestions.push([a,b]);
  state.allCorrect = false;
  state.idx++;
  showQuestion();
}

function endQuiz(){
  clearInterval(state.timerId);
  if(!state.firstRunFinished) state.firstRunFinished = true;

  if(state.isReview){
    if(state.allCorrect){ clearMistakes(); }
  } else {
    saveMistakes(state.wrongQuestions); // keep only last session
  }

  if(state.isReview) state.wrongQuestions = [];
  if(state.allCorrect) alert('Perfect! All answers are correct.');
  setView(false); refreshReview();
  scroller.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ===== Keyboard submit (Desktop only) ===== */
if (!isMobile) {
  elAns.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      onSubmit(); // desktop: Enter submits
    }
  });
}

/* ===== Buttons ===== */
elSubmit.addEventListener('click', onSubmit);

elStart.addEventListener('click', () => {
  saveSettings();
  const fontSize = clampQ(parseInt(elFS.value,10) || 120);
  const total    = Math.max(1, parseInt(elTQ.value,10) || 10);
  state.timeLimit= Math.max(1, parseInt(elTL.value,10) || 5);
  state.fontSize = fontSize;
  document.documentElement.style.setProperty('--quiz-font-size', fontSize + 'px');

  const storedMistakes = loadMistakes();
  const canReview = storedMistakes.length > 0;
  state.isReview = !!elReview.checked && canReview;

  state.results = []; state.allCorrect = true;
  if(state.isReview){
    state.questions = storedMistakes.map(p => [parseInt(p[0],10), parseInt(p[1],10)]);
  } else {
    state.questions = makeQuestions(total, elSeries.value);
  }
  state.wrongQuestions = [];
  state.idx = 0;

  setView(true);
  showQuestion();

  // first question: enforce focus within gesture (helps mobile)
  ensureMobileKeyboard(elAns, true);

  // one-time safety: if first attempt fails, refocus on next user action
  const safety = () => {
    ensureMobileKeyboard(elAns, true);
    document.removeEventListener('pointerup', safety, {passive:true});
    document.removeEventListener('touchend', safety, {passive:true});
    document.removeEventListener('click', safety, {passive:true});
  };
  document.addEventListener('pointerup', safety, {passive:true, once:true});
  document.addEventListener('touchend', safety, {passive:true, once:true});
  document.addEventListener('click', safety, {passive:true, once:true});
});

/* ===== CSV export ===== */
function exportCsv(){
  const rows=[['A','B','Correct','YourAns','Status'], ...state.results];
  const csv = rows.map(r => r.map(x => String(x).replace(/"/g,'""'))
                             .map(x => /[",\n]/.test(x)?`"${x}"`:x).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'quiz_results.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}
elExport.addEventListener('click', exportCsv);

/* ===== SW ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
}

/* ===== Init ===== */
loadSettings();
refreshReview();
})();
</script>
</body>
</html>
